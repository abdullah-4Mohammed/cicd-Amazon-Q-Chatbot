# steps:
# - task: AWSShellScript@1
#   displayName: 'Create Application'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     scriptType: 'inline'
#     inlineScript: |
#       set -euxo pipefail

#       # Run the AWS CLI command
#       output=$(aws qbusiness create-application --region "$(region)" --display-name "$(serviceName)" --identity-center-instance-arn "$(identityCenterInstanceARN)" --role-arn "$(amazon-q-roleARN)" --description "Amazon Q Chatbot" --output json)

#       # Extract the applicationId using jq
#       applicationId=$(echo "$output" | jq -r '.applicationId')

#       # Set the pipeline variable
#       echo "##vso[task.setvariable variable=application_Id;isOutput=true]$applicationId"

#       # Print the applicationId for debugging
#       echo "applicationId: $applicationId"
#   name: createApplication
steps:
- task: AWSShellScript@1
  displayName: 'Create Application'
  inputs:
    awsCredentials: '$(awsConnection)'
    regionName: '$(region)'
    scriptType: 'inline'
    inlineScript: |
      set -euxo pipefail

      # Try to create the application
      output=$(aws qbusiness create-application --region "$(region)" --display-name "$(serviceName)" --identity-center-instance-arn "$(identityCenterInstanceARN)" --role-arn "$(amazon-q-roleARN)" --description "Amazon Q Chatbot" --output json) || true

      # If the application was not created, get the existing applicationId
      if [ -z "$output" ]; then
        output=$(aws qbusiness list-applications --region "$(region)" --output json)
        applicationId=$(echo "$output" | jq -r --arg serviceName "$(serviceName)" '.applications[] | select(.displayName == $serviceName) | .applicationId')
      else
        applicationId=$(echo "$output" | jq -r '.applicationId')
      fi

      # Set the pipeline variable
      echo "##vso[task.setvariable variable=application_Id;isOutput=true]$applicationId"

      # Print the applicationId for debugging
      echo "applicationId: $applicationId"
  name: createApplication


- task: AWSShellScript@1
  displayName: 'Create Web Experience'
  inputs:
    awsCredentials: '$(awsConnection)'
    regionName: '$(region)'
    scriptType: 'inline'
    inlineScript: |
      set -euxo pipefail

      # Run the AWS CLI command to create a web experience
      webExperienceOutput=$(aws qbusiness create-web-experience --region "$(region)" --application-id "$(createApplication.application_Id)" --role-arn "$(web-experience-roleARN)" --output json)

      # Extract the webExperienceId using jq
      webExperienceId=$(echo "$webExperienceOutput" | jq -r '.webExperienceId')

      # Set the pipeline variable
      echo "##vso[task.setvariable variable=webExperience_Id;isOutput=true]$webExperienceId"

      # Print the webExperienceId for debugging
      echo "webExperienceId: $webExperienceId"
  name: createWebExperience




# - task: AWSCLI@1
#   displayName: 'Create Application'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-application'
#     awsArguments: >-
#       --display-name "$(serviceName)"
#       --identity-center-instance-arn "$(identityCenterInstanceARN)"
#       --role-arn "$(amazon-q-roleARN)"
#       --description "Amazon Q Chatbot"

#     scriptType: 'inline'
#     inlineScript: |
#       set -ex
#       applicationId=$(aws qbusiness create-application --display-name "$(serviceName)" --identity-center-instance-arn "$(identityCenterInstanceARN)" --role-arn "$(amazon-q-roleARN)" --description "Amazon Q Chatbot" --query 'applicationId' --output text)
#       echo "##vso[task.setvariable variable=application_Id;isOutput=true]$applicationId"
#       echo "applicationId: $applicationId"
#       echo "application_Id: $(application_Id)"
# #    continueOnError: false
# #    condition: succeededOrFailed()
#   name: createApplication

# - task: AWSCLI@1
#   displayName: 'Create Web Experience'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-web-experience'
#     awsArguments: >-
#       --application-id "$(application_Id)"  
#       --title "Test Chatbot - Title"
#       --subtitle "Test - subtitle"
#       --welcome-message "Hello, how can I help you today? - this is the welcome message"
#       --sample-prompts-control-mode "DISABLED"
#       --role-arn "$(amazon-q-roleARN)"
#   name: createWebExperience




# steps:

# - task: AWSCLI@1
#   displayName: 'Create Application'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-application'
#     awsArguments: >-
#       --display-name "$(serviceName)"
#       --identity-center-instance-arn "$(identityCenterInstanceARN)"
#       --role-arn "$(amazon-q-roleARN)"
#       --description "Amazon Q Chatbot"
#     scriptType: 'bash'
#     scriptLocation: 'inline'
#     inlineScript: |
#       output=$(aws qbusiness create-application --display-name "$(serviceName)" --identity-center-instance-arn "$(identityCenterInstanceARN)" --role-arn "$(amazon-q-roleARN)" --description "Amazon Q Chatbot")
#       applicationId=$(echo $output | jq -r '.applicationId')
#       echo "##vso[task.setvariable variable=q-applicationId]$applicationId"
#       echo "applicationId: $applicationId"
#       echo " q-applicationId: $q-applicationId"
#   continueOnError: false
#   condition: succeededOrFailed()
#   name: createApplication  # This name allows referencing the task output in subsequent steps.

# - task: AWSCLI@1
#   displayName: 'Create Web Experience'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     inlineScript: |
#       echo "q-applicationId: $(q-applicationId)"
#       echo "applicationId: $(applicationId)"
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-web-experience'
#     awsArguments: >-
#       --application-id "$(q-applicationId)"
#       --title "Test Chatbot - Title"
#       --subtitle "Test - subtitle"
#       --welcome-message "Hello, how can I help you today? - this is the welcome message"
#       --sample-prompts-control-mode "DISABLED"
#       --role-arn "$(amazon-q-roleARN)"
#   name: createWebExperience  # Naming this task for referencing in the next step.

# - task: AWSCLI@1
#   displayName: 'List Web Experiences'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'get-web-experience'
#     awsArguments: >-
#       --application-id "$(amazon-q-applicationId)"
#       --max-results 10

# - task: AWSCLI@1
#   displayName: 'Update Web Experience'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'update-web-experience'
#     awsArguments: >-
#       --application-id "$(amazon-q-applicationId)"
#       --web-experience-id "$(amazonQWebExperienceId)"
#       --role-arn "$(amazon-q-roleARN)"
#       --title "Updated Web Experience Title"
#       --subtitle "Updated subtitle of your web experience"
#       --welcome-message "Updated welcome message for your web experience"
#       --sample-prompts-control-mode "DISABLED"



#creating works fine

# - task: AWSCLI@1
#   displayName: 'Create Amazon Q Application'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-application'
#     awsArguments: >-
#       --display-name "$(serviceName)"
#       --identity-center-instance-arn "$(identityCenterInstanceARN)"
#       --role-arn "$(amazon-q-roleARN)"
#       --description "Amazon Q Chatbot"
# #      --encryption-configuration "kmsKeyId=auto-kendra-1"
# #      --attachments-configuration "attachmentsControlMode=ENABLED"
#   continueOnError: false
#   condition: succeededOrFailed()
#   name: createApplication  # This name allows referencing the task output in subsequent steps.

#end creating works fine
