steps:
- task: Bash@3
  displayName: 'Create Application and Capture Application ID'
  inputs:
    targetType: 'inline'
    script: |
      aws --version

      output=$(aws qbusiness create-application --display-name "$(serviceName)" --identity-center-instance-arn "$(identityCenterInstanceARN)" --role-arn "$(amazon-q-roleARN)" --description "Amazon Q Chatbot")

      echo "AWS CLI output: $output"

      applicationId=$(echo "$output" | jq -r '.applicationId')

      echo "##vso[task.setvariable variable=q-applicationId]$applicationId"

      echo "Application ID: $applicationId"
  continueOnError: false
  condition: always()
  name: createAndSetApplicationId

- task: AWSCLI@1
  displayName: 'Create Web Experience'
  inputs:
    awsCredentials: '$(awsConnection)'
    regionName: '$(region)'
    awsCommand: 'qbusiness'
    awsSubCommand: 'create-web-experience'
    awsArguments: >-
      --application-id "$(q-applicationId)"
      --title "Test Chatbot - Title"
      --subtitle "Test - subtitle"
      --welcome-message "Hello, how can I help you today? - this is the welcome message"
      --sample-prompts-control-mode "DISABLED"
      --role-arn "$(amazon-q-roleARN)"
  name: createWebExperience
  continueOnError: false
  condition: always()







# steps:

# - task: AWSCLI@1
#   displayName: 'Create Application'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-application'
#     awsArguments: >-
#       --display-name "$(serviceName)"
#       --identity-center-instance-arn "$(identityCenterInstanceARN)"
#       --role-arn "$(amazon-q-roleARN)"
#       --description "Amazon Q Chatbot"
#     scriptType: 'bash'
#     scriptLocation: 'inline'
#     inlineScript: |
#       output=$(aws qbusiness create-application --display-name "$(serviceName)" --identity-center-instance-arn "$(identityCenterInstanceARN)" --role-arn "$(amazon-q-roleARN)" --description "Amazon Q Chatbot")
#       applicationId=$(echo $output | jq -r '.applicationId')
#       echo "##vso[task.setvariable variable=amazon-q-applicationId]$applicationId"
#   continueOnError: false
#   condition: succeededOrFailed()
#   name: createApplication  # This name allows referencing the task output in subsequent steps.

# - task: AWSCLI@1
#   displayName: 'Create Web Experience'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-web-experience'
#     awsArguments: >-
#       --application-id "$(amazon-q-applicationId)"
#       --title "Test Chatbot - Title"
#       --subtitle "Test - subtitle"
#       --welcome-message "Hello, how can I help you today? - this is the welcome message"
#       --sample-prompts-control-mode "DISABLED"
#       --role-arn "$(amazon-q-roleARN)"
#   name: createWebExperience  # Naming this task for referencing in the next step.

# - task: AWSCLI@1
#   displayName: 'List Web Experiences'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'get-web-experience'
#     awsArguments: >-
#       --application-id "$(amazon-q-applicationId)"
#       --max-results 10

# - task: AWSCLI@1
#   displayName: 'Update Web Experience'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'update-web-experience'
#     awsArguments: >-
#       --application-id "$(amazon-q-applicationId)"
#       --web-experience-id "$(amazonQWebExperienceId)"
#       --role-arn "$(amazon-q-roleARN)"
#       --title "Updated Web Experience Title"
#       --subtitle "Updated subtitle of your web experience"
#       --welcome-message "Updated welcome message for your web experience"
#       --sample-prompts-control-mode "DISABLED"



#creating works fine

# - task: AWSCLI@1
#   displayName: 'Create Amazon Q Application'
#   inputs:
#     awsCredentials: '$(awsConnection)'
#     regionName: '$(region)'
#     awsCommand: 'qbusiness'
#     awsSubCommand: 'create-application'
#     awsArguments: >-
#       --display-name "$(serviceName)"
#       --identity-center-instance-arn "$(identityCenterInstanceARN)"
#       --role-arn "$(amazon-q-roleARN)"
#       --description "Amazon Q Chatbot"
# #      --encryption-configuration "kmsKeyId=auto-kendra-1"
# #      --attachments-configuration "attachmentsControlMode=ENABLED"
#   continueOnError: false
#   condition: succeededOrFailed()
#   name: createApplication  # This name allows referencing the task output in subsequent steps.

#end creating works fine
